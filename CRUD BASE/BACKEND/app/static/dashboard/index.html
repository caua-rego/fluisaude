<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FluiSaúde — Dashboard</title>
  <style>
    /* Reset + base */
    *{box-sizing:border-box}html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#0f172a;background:linear-gradient(180deg,#f8fafc 0%,#eef2ff 100%)}
    a{color:inherit}

    /* Layout */
    .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
    aside{background:#0f172a;color:#fff;padding:28px;display:flex;flex-direction:column;gap:20px}
    main{padding:28px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#06b6d4,#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
    h1{font-size:20px;margin:0}
    nav{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .nav-btn{background:transparent;border:0;color:#cbd5e1;padding:10px 12px;text-align:left;border-radius:8px;cursor:pointer;transition:all .18s}
    .nav-btn:hover{background:rgba(255,255,255,0.04);color:#fff;transform:translateX(6px)}
    .nav-btn.active{background:rgba(255,255,255,0.06);color:#fff}

    /* Header */
    header.top{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .search{flex:1;margin-left:12px}
    .controls{display:flex;gap:8px}

    /* Cards and tables */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:20px}
    .card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06);transition:transform .18s}
    .card:hover{transform:translateY(-6px)}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #eef2ff}
    th{color:#334155;text-align:left}

    /* Forms */
    form.inline{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:10px;border-radius:8px;border:1px solid #e6eefc}
    input,select{background:#fff}
    button.primary{background:linear-gradient(90deg,#06b6d4,#7c3aed);color:white;border:0}
    button.ghost{background:transparent;border:1px solid #e6eefc}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.5)}
    .modal.show{display:flex}
    .modal .panel{width:720px;background:#fff;padding:20px;border-radius:12px}

    /* Animations */
    @keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-8px)}100%{transform:translateY(0)}}
    .spark{width:10px;height:10px;border-radius:50%;background:linear-gradient(90deg,#06b6d4,#7c3aed);animation:floaty 3s ease-in-out infinite}

    /* Responsive */
    @media (max-width:900px){.app{grid-template-columns:1fr}.aside{display:none}.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <aside>
      <div class="brand">
        <div class="logo">FS</div>
        <div>
          <h1>FluiSaúde</h1>
          <div style="font-size:12px;color:#94a3b8">Painel de administração</div>
        </div>
      </div>

      <nav>
        <button class="nav-btn active" data-section="overview">Visão geral</button>
        <button class="nav-btn" data-section="pacientes">Pacientes</button>
        <button class="nav-btn" data-section="medicos">Médicos</button>
        <button class="nav-btn" data-section="especialidades">Especialidades</button>
        <button class="nav-btn" data-section="consultas">Consultas</button>
      </nav>

      <div style="margin-top:auto;font-size:12px;color:#94a3b8">Rodando com: <strong>/api</strong></div>
    </aside>

    <main>
      <header class="top">
        <div style="display:flex;align-items:center;gap:12px">
          <h2 id="sectionTitle">Visão geral</h2>
          <div class="spark"></div>
        </div>
        <div class="controls">
          <button class="ghost" id="refreshBtn">Atualizar</button>
          <button class="primary" id="openCreate">Adicionar</button>
        </div>
      </header>

      <section id="overview">
        <div class="grid">
          <div class="card"><strong id="countPacientes">0</strong><div style="color:#64748b">Pacientes</div></div>
          <div class="card"><strong id="countMedicos">0</strong><div style="color:#64748b">Médicos</div></div>
          <div class="card"><strong id="countConsultas">0</strong><div style="color:#64748b">Consultas</div></div>
        </div>
      </section>

      <section id="contentArea" style="margin-top:18px">
        <!-- dynamic content goes here -->
      </section>
    </main>
  </div>

  <!-- modal (reused) -->
  <div class="modal" id="modal">
    <div class="panel">
      <h3 id="modalTitle">Criar</h3>
      <div id="modalBody"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="ghost" id="modalClose">Cancelar</button>
        <button class="primary" id="modalSave">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    const API = '/api';

    // simple router for sections
    const sections = ['overview','pacientes','medicos','especialidades','consultas'];
    const navButtons = document.querySelectorAll('.nav-btn');
    const sectionTitle = document.getElementById('sectionTitle');
    const contentArea = document.getElementById('contentArea');
    const modal = document.getElementById('modal');
    const modalBody = document.getElementById('modalBody');
    const modalTitle = document.getElementById('modalTitle');

    function setActive(name){
      navButtons.forEach(b=>b.classList.toggle('active', b.dataset.section===name));
      sectionTitle.textContent = name.charAt(0).toUpperCase()+name.slice(1);
      renderSection(name);
    }

    navButtons.forEach(b=>b.addEventListener('click', ()=>setActive(b.dataset.section)));

    document.getElementById('refreshBtn').addEventListener('click', ()=>{ loadCounts(); renderSection(currentSection); });
    document.getElementById('openCreate').addEventListener('click', ()=>openModalForCreate(currentSection));
    document.getElementById('modalClose').addEventListener('click', ()=>modal.classList.remove('show'));
    document.getElementById('modalSave').addEventListener('click', ()=>submitModal());

    let currentSection = 'overview';

    // Counts
    async function loadCounts(){
      try{
        const [p,m,c] = await Promise.all([
          fetch(`${API}/pacientes`).then(r=>r.json()),
          fetch(`${API}/medicos`).then(r=>r.json()),
          fetch(`${API}/consultas`).then(r=>r.json())
        ]);
        document.getElementById('countPacientes').textContent = p.length;
        document.getElementById('countMedicos').textContent = m.length;
        document.getElementById('countConsultas').textContent = c.length;
      }catch(e){ console.error('Erro ao carregar counts',e); }
    }

    function renderSection(name){
      currentSection = name;
      if(name==='overview'){ contentArea.innerHTML = `<div class="card"><em>Use o botão "Adicionar" para criar recursos, ou navegue nas guias à esquerda.</em></div>`; return; }
      if(name==='pacientes'){ renderPacientes(); return; }
      if(name==='medicos'){ renderMedicos(); return; }
      if(name==='especialidades'){ renderEspecialidades(); return; }
      if(name==='consultas'){ renderConsultas(); return; }
    }

    // --- Pacientes ---
    async function renderPacientes(){
      const res = await fetch(`${API}/pacientes`); const data = await res.json();
      contentArea.innerHTML = `
        <div class="card">
          <form class="inline" id="searchPaciente"><input placeholder="Buscar por nome/CPF" id="qPaciente"><button class="ghost" type="button" id="btnSearch">Buscar</button></form>
        </div>
        <div class="card"><table><thead><tr><th>ID</th><th>Nome</th><th>CPF</th><th>Tel</th><th>Ações</th></tr></thead><tbody id="pacBody"></tbody></table></div>
      `;
      const tbody = document.getElementById('pacBody'); tbody.innerHTML=''; data.forEach(p=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.id}</td><td>${p.nome}</td><td>${p.cpf}</td><td>${p.telefone||''}</td><td><button data-id="${p.id}" data-action="edit">Editar</button> <button data-id="${p.id}" data-action="del">Deletar</button></td>`; tbody.appendChild(tr); });
      tbody.addEventListener('click', async (ev)=>{
        const b = ev.target.closest('button'); if(!b) return; const id=b.dataset.id; if(b.dataset.action==='edit'){ openModalForEdit('pacientes', id); } else if(b.dataset.action==='del' && confirm('Deletar?')){ await fetch(`${API}/pacientes/${id}`,{method:'DELETE'}); renderPacientes(); loadCounts(); }
      });
    }

    // --- Medicos ---
    async function renderMedicos(){
      const res = await fetch(`${API}/medicos`); const data = await res.json();
      contentArea.innerHTML = `<div class="card"><table><thead><tr><th>ID</th><th>Nome</th><th>CRM</th><th>Esp</th><th>Ações</th></tr></thead><tbody id="medBody"></tbody></table></div>`;
      const tbody = document.getElementById('medBody'); tbody.innerHTML=''; data.forEach(m=>{ const espName = m.especialidade?.nome || (m.especialidade_id?('#'+m.especialidade_id):'N/A'); const tr=document.createElement('tr'); tr.innerHTML=`<td>${m.id}</td><td>${m.nome}</td><td>${m.crm}</td><td>${espName}</td><td><button data-id="${m.id}" data-action="edit">Editar</button> <button data-id="${m.id}" data-action="del">Deletar</button></td>`; tbody.appendChild(tr); });
      tbody.addEventListener('click', async (ev)=>{ const b=ev.target.closest('button'); if(!b) return; const id=b.dataset.id; if(b.dataset.action==='edit'){ openModalForEdit('medicos', id); } else if(b.dataset.action==='del' && confirm('Deletar?')){ await fetch(`${API}/medicos/${id}`,{method:'DELETE'}); renderMedicos(); loadCounts(); } });
    }

    // --- Especialidades ---
    async function renderEspecialidades(){ const res=await fetch(`${API}/especialidades`); const data=await res.json(); contentArea.innerHTML = `<div class="card"><table><thead><tr><th>ID</th><th>Nome</th><th>Ações</th></tr></thead><tbody id="espBody"></tbody></table></div>`; const tbody=document.getElementById('espBody'); tbody.innerHTML=''; data.forEach(e=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${e.id}</td><td>${e.nome}</td><td><button data-id="${e.id}" data-action="edit">Editar</button> <button data-id="${e.id}" data-action="del">Deletar</button></td>`; tbody.appendChild(tr); }); tbody.addEventListener('click', async (ev)=>{ const b=ev.target.closest('button'); if(!b) return; const id=b.dataset.id; if(b.dataset.action==='edit'){ openModalForEdit('especialidades', id); } else if(b.dataset.action==='del' && confirm('Deletar?')){ await fetch(`${API}/especialidades/${id}`,{method:'DELETE'}); renderEspecialidades(); loadCounts(); } }); }

    // --- Consultas ---
    async function renderConsultas(){ const res=await fetch(`${API}/consultas`); const data=await res.json(); contentArea.innerHTML = `<div class="card"><table><thead><tr><th>ID</th><th>Paciente</th><th>Médico</th><th>Data</th><th>Status</th><th>Ações</th></tr></thead><tbody id="consBody"></tbody></table></div>`; const tbody=document.getElementById('consBody'); tbody.innerHTML=''; data.forEach(c=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.id}</td><td>${c.paciente_id}</td><td>${c.medico_id}</td><td>${c.data_agendamento}</td><td>${c.status}</td><td><button data-id="${c.id}" data-action="edit">Editar</button> <button data-id="${c.id}" data-action="del">Deletar</button></td>`; tbody.appendChild(tr); }); tbody.addEventListener('click', async (ev)=>{ const b=ev.target.closest('button'); if(!b) return; const id=b.dataset.id; if(b.dataset.action==='edit'){ openModalForEdit('consultas', id); } else if(b.dataset.action==='del' && confirm('Deletar?')){ await fetch(`${API}/consultas/${id}`,{method:'DELETE'}); renderConsultas(); loadCounts(); } }); }

    // Modal helpers
    async function openModalForCreate(section){ modalTitle.textContent = 'Criar ' + section; modalBody.innerHTML = formFor(section); modal.classList.add('show'); }
    async function openModalForEdit(section,id){ modalTitle.textContent = 'Editar ' + section; const res=await fetch(`${API}/${section}/${id}`); const data=await res.json(); modalBody.innerHTML = formFor(section,data); modal.classList.add('show'); }
    function formFor(section,data={}){
      if(section==='pacientes') return `<div><label>Nome</label><input id="f_nome" value="${data.nome||''}"></div><div><label>CPF</label><input id="f_cpf" value="${data.cpf||''}"></div><div><label>Telefone</label><input id="f_tel" value="${data.telefone||''}"></div><input type="hidden" id="f_id" value="${data.id||''}">`;
      if(section==='medicos') return `<div><label>Nome</label><input id="f_nome" value="${data.nome||''}"></div><div><label>CRM</label><input id="f_crm" value="${data.crm||''}"></div><div><label>Especialidade ID</label><input id="f_esp" value="${data.especialidade_id||''}"></div><input type="hidden" id="f_id" value="${data.id||''}">`;
      if(section==='especialidades') return `<div><label>Nome</label><input id="f_nome" value="${data.nome||''}"></div><input type="hidden" id="f_id" value="${data.id||''}">`;
  if(section==='consultas') return `<div><label>Paciente ID</label><input id="f_pac" value="${data.paciente_id||''}"></div><div><label>Ou buscar por CPF</label><div style="display:flex;gap:8px;margin-top:6px"><input id="f_pac_cpf" placeholder="CPF (somente números)" value=""><button class="ghost" type="button" id="btnBuscarCpf">Buscar</button><div id="pacienteEncontrado" style="margin-left:8px;color:#0f172a"></div></div></div><div><label>Médico ID</label><input id="f_med" value="${data.medico_id||''}"></div><div><label>Data</label><input id="f_data" type="datetime-local" value="${data.data_agendamento||''}" required></div><div><label>Status</label><input id="f_status" value="${data.status||'agendada'}"></div><input type="hidden" id="f_id" value="${data.id||''}">`;
      return '';
    }

    // minimal validation and submission
    async function submitModal(){ const sec = currentSection; const id = document.getElementById('f_id').value; try{
      let body={};
      if(sec==='pacientes'){ body={nome:document.getElementById('f_nome').value, cpf:document.getElementById('f_cpf').value, telefone:document.getElementById('f_tel').value}; }
      if(sec==='medicos'){ body={nome:document.getElementById('f_nome').value, crm:document.getElementById('f_crm').value, especialidade_id:parseInt(document.getElementById('f_esp').value||0)} }
      if(sec==='especialidades'){ body={nome:document.getElementById('f_nome').value} }
  if(sec==='consultas'){ const pac = document.getElementById('f_pac').value; const med = document.getElementById('f_med').value; const dataVal = document.getElementById('f_data').value; if(!pac||!med||!dataVal){ alert('Preencha paciente, médico e data (calendário).'); return; } body={paciente_id:parseInt(pac||0), medico_id:parseInt(med||0), data_agendamento:dataVal, status:document.getElementById('f_status').value} }
      if(id){ await fetch(`${API}/${sec}/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); } else { await fetch(`${API}/${sec}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); }
      modal.classList.remove('show'); renderSection(sec); loadCounts();
    }catch(e){ console.error(e); alert('Erro'); }
    }

    // init
    setActive('overview'); loadCounts();
  </script>
</body>
</html>
